$def with (pid, erfahrung)

<style type="text/css">
#row_prototype {display: none;}
#error {display: none}
</style>

<script type="application/javascript">

var erfahrung = {
	count: 0,
	errors: false,

	clone_row: function(ix, was, wo, jahr, monate) {
		var new_row = $$("#row_prototype").clone(true);
		new_row.attr("id", "row_" + ix);
	
		var inputs = $$("input", new_row)
		for (i=0; i<inputs.length; i++) {
			inputs[i].setAttribute("name", inputs[i].name + ix)
			inputs[i].setAttribute("id", inputs[i].name)
		}
		
		inputs = $$("select", new_row)
		for (i=0; i<inputs.length; i++) {
			inputs[i].setAttribute("name", inputs[i].name + ix)
			inputs[i].setAttribute("id", inputs[i].name)
		}
		
		$$("#erfahrungform").append(new_row)
		$$("#was_"+ix).val(was)
		$$("#wo_"+ix).val(wo)
		$$("#von_j_"+ix).val(jahr)
		$$("#dauer_"+ix).val(monate)
	},

	validate: function(el, state) {
		var e = $$("#" + el)
		//console.log(el + " " + e.val())
		if (!e.val()) {
			e.parent().addClass("has-error")
			erfahrung.errors = true;
		} else {
			e.parent().removeClass("has-error")
			if (e.attr("placeholder") == "Jahr") {
				// must be greater than 1950
				if (parseInt(e.val()) > 1900) {
					e.parent().removeClass("has-error")
				}	else {
					e.parent().addClass("has-error")
					erfahrung.errors = true
				}
			}
		}
	},

	collect: function() {
		result = []
		erfahrung.errors = false;
		for (i=0; i<erfahrung.count; i++) {
			//console.log(i)
			row = {
				was: $$("#was_"+i).val(),
				ort: $$("#ort_"+i).val(),
				von: "" + $$("#von_j_"+i).val(),
				dauer: "" + $$("#dauer_"+i).val()
			}
		
			//console.log(row.was)
			//console.log(row.ort)
			if (row.was || row.ort) {
			
				// validate
				if (!row.was) row.was = "";
				if (!row.ort) row.ort = "";
			
				erfahrung.validate("von_j_"+i);
				erfahrung.validate("dauer_"+i);
			
				result[i] = row;
			}
		}
	
		if (erfahrung.errors)
			$$("#error").css("display", "block");
		else
			$$("#error").css("display", "none");


		$$.ajax({
			type: "POST",
			url: "erfahrung/" + app.selected_pid,
			// The key needs to match your method's input parameter (case-sensitive).
			data: JSON.stringify({ erfahrung: result }),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function(data){
				app.log(data);
			},
			failure: function(errMsg) {
				alert(errMsg);
			}
		});

		//app.log(result)
	}
}

add_load_handler(function() {
	if (erfahrung.count == 0) {
		$for e in erfahrung:
			erfahrung.clone_row(erfahrung.count++, '$e.was', '$e.ort', $e.von_mj, $e.monate)
		
	}
	erfahrung.clone_row(erfahrung.count++)
	erfahrung.clone_row(erfahrung.count++)
})
</script>

<h1>
<span class="glyphicon glyphicon-book"></span>
Anästhesie Erfahrung</h1>

<form class="form-inline row" id="erfahrungform" method="post" action="">

<div id="row_prototype">
	<div class="col-sm-5 col-xs-12">
		<input type="text" value="" name="was_" id="was_" size="12" class="form-control" placeholder="Rotation"/>
		<input type="text" value="" name="ort_" id="ort_" size="25" class="form-control" placeholder="Ort"/>
	</div>


	<div class="col-sm-7 col-xs-12">
		<div class="form-group">
			<label>Beginn: </label>
			<input type="number" value="" name="von_j_" id="von_j_" size="4" class="form-control" placeholder="Jahr" min="1950" max="2100" step="1"/>
		</div>

		<div class="form-group">
			<label>Dauer: </label>
			<input type="number" value="" name="dauer_" id="dauer_" size="2" class="form-control" placeholder="Monate" min="1" max="100"  step="1"/>
		</div>
	</div>
</div>

<div class="alert alert-danger" role="alert" id="error">
	<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
  <span class="sr-only">Error:</span>
	Bitte füllen Sie die rot markierten Felder korrekt aus.
</div>

</form>

<button class="btn" onclick="erfahrung.clone_row(erfahrung.count++)">
<span class="glyphicon glyphicon-plus"></span>
Mehr</button>
<button class="btn" onclick="erfahrung.collect()">
<span class="glyphicon glyphicon-floppy-disk"></span>
Speichern</button>

<h1>
<span class="glyphicon glyphicon-book"></span>
Weiterbildungen</h1>

<form class="form-inline row" id="fbform" method="post" action="erfahrung/wb/$pid">

	<div class="col-sm-6 col-xs-12">
		<div class="checkbox">
			<label>
				<input type="checkbox" name="atls"/> ATLS
			</label>
			<input type="number" value="" name="atls_j" id="atls_j" size="4" class="form-control" placeholder="Jahr" min="1950" max="2100" step="1"/>
			<input type="text" value="" name="atls_ort" id="atls_ort" size="25" class="form-control" placeholder="Ort"/>
		</div>	
		<div class="checkbox">
			<label>
				<input type="checkbox" name="acls"/> ACLS
			</label>
			<input type="number" value="" name="acls_j" id="atls_j" size="4" class="form-control" placeholder="Jahr" min="1950" max="2100" step="1"/>
			<input type="text" value="" name="acls_ort" id="atls_ort" size="25" class="form-control" placeholder="Ort"/>
		</div>	
		<div class="checkbox">
			<label>
				<input type="checkbox" name="pals"/> PALS
			</label>
			<input type="number" value="" name="pals_j" id="atls_j" size="4" class="form-control" placeholder="Jahr" min="1950" max="2100" step="1"/>
			<input type="text" value="" name="pals_ort" id="atls_ort" size="25" class="form-control" placeholder="Ort"/>
		</div>	
	</div>
	
</form>
